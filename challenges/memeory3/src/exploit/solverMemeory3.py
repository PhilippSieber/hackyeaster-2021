#!/usr/bin/env python2
import cookielib,Cookie,urllib2,urllib
import math
import time
import json
import glob
import requests
import operator
from PIL import Image
import os
import imagehash

cookies = cookielib.CookieJar()
opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookies))

#baseUrl = "http://localhost:9000"
baseUrl = "http://46.101.107.117:2107"
sessionId = ""
pairs = []

def getImage(id):
    request=urllib2.Request(baseUrl+"/pic/"+str(id))
    response = opener.open(request)
    data = response.read()
    file = open("img/pic"+str(id)+".jpg","wb") 
    file.write(data) 
    file.close() 
    response.close()

def solve(first, second):
    di = dict(first=first, second=second)
    data = urllib.urlencode(di)

    requestVerify=urllib2.Request(baseUrl+"/solve", data=data)
    requestVerify.add_header("Content-Type",'application/x-www-form-urlencoded')
    #print sessionId
    requestVerify.add_header("Cookie",'sessionId='+sessionId)
    requestVerify.get_method = lambda: "POST"
    response = opener.open(requestVerify)
    data = response.read()
    print first, second, data
    return str(data)

def difference(img1, img2):
    hash = imagehash.average_hash(Image.open(img1))
    otherhash = imagehash.average_hash(img2)
    return hash - otherhash
    
    
def compareAndSetRms(rmsTmp, rms, imgFile):
    global winner
    if(rmsTmp<rms):
        winner=imgFile
        return rmsTmp
    return rms

def findPair(filename, pairs):
    rms=100
    global winner
    winner=""
    for imgFile in glob.glob('img/*.jpg'):
        if(not filename == imgFile):
            if(getIdFromFile(imgFile) in pairs):
                continue
                            
            im1 = Image.open(imgFile)
            rmsTmp = difference(filename, im1)
            rms = compareAndSetRms(rmsTmp, rms, imgFile)  
            
            im1 = im1.rotate(90, Image.NEAREST, expand = 1) #rotate 90
            rmsTmp = difference(filename, im1)
            rms = compareAndSetRms(rmsTmp, rms, imgFile)  
            
            im1 = im1.rotate(180, Image.NEAREST, expand = 1)  #rotate 180
            rmsTmp = difference(filename, im1)
            rms = compareAndSetRms(rmsTmp, rms, imgFile)  
            
            im1 = im1.rotate(270, Image.NEAREST, expand = 1) #rotate 270
            rmsTmp = difference(filename, im1)
            rms = compareAndSetRms(rmsTmp, rms, imgFile)  
                        
            if(rms==0):
                return winner #perfect match
            
    return winner

def getIdFromFile(filename):
    return filename.replace("img/pic","").replace(".jpg","");

# first to get sessionId
request=urllib2.Request(baseUrl)
response = opener.open(request)
data = response.read()
data = dict((cookie.name, cookie.value) for cookie in cookies)
sessionId = data['sessionId'];
response.close()

"""
get image, verify, new round
"""
def solveRnd(i):
    pairs = []
    print "getting pairs for round: "+str(i)
    for i in xrange(1,99):
        getImage(i)

    # search pairs
    for imgFile in glob.glob('img/*.jpg'):
        if(not getIdFromFile(imgFile) in pairs):
            first =  getIdFromFile(imgFile)
            second =  getIdFromFile(findPair(imgFile, pairs))
            res = solve(first, second)
            if(res.startswith("not ok") or res=="restart"):
                print "stop"
                return False
            pairs.append(first)
            pairs.append(second)
    return True
for i in range(10):
    time.sleep(2)
    if(not solveRnd(i+1)):
        break
        